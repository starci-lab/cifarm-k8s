---
# Source: rest-api-gateway/templates/service-load-balancer.yaml
apiVersion: v1
kind: Service
metadata:
  name: websocket-api-gateway-load-balancer
  labels:
    mode: deploy
spec:
  selector:
    app.kubernetes.io/name: websocket-api-gateway
  ports:
    - port: 3003
      targetPort: 3003
  type: LoadBalancer

#kubectl exec -it websocket-api-gateway-deployment-7b9b75f985-5cps2 -- netstat -tuln
---
# Source: rest-api-gateway/templates/service-node-port.yaml
apiVersion: v1
kind: Service
metadata:
  name: websocket-api-gateway-node-port
  labels:
    mode: test
spec:
  selector:
    app.kubernetes.io/name: websocket-api-gateway
  type: NodePort
  ports:
    - port: 3003
      targetPort: 3003
      nodePort: 30123
---
# Source: rest-api-gateway/templates/kaniko-build.yaml
apiVersion: v1
kind: Pod
metadata:
  name: websocket-api-gateway-kaniko-build
  labels: 
    mode: build
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    args:
      - "--context=git://github.com/starci-lab/cifarm-containers"
      - "--destination=starci183/rest-api-gateway:latest"
      - "--dockerfile=./apps/websocket-api-gateway/Dockerfile"
    resources:
      limits:
        cpu: "2"
        memory: "2Gi"
    volumeMounts:
      - name: kaniko-secret
        mountPath: /kaniko/.docker
  restartPolicy: Never
  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
        items:
          - key: .dockerconfigjson
            path: config.json
---
# Source: rest-api-gateway/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: websocket-api-gateway-deployment
  labels:
    mode: deploy
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: websocket-api-gateway
  template:
    metadata:
      name: websocket-api-gateway
      labels:
        app.kubernetes.io/name: websocket-api-gateway
    spec:
      containers:
        - name: websocket-api-gateway
          image: starci183/rest-api-gateway:latest
          imagePullPolicy: Never
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
          envFrom:
            - secretRef:
                name: websocket-api-gateway-env
          ports:
            - containerPort: 3003

#one replica - for testing
#kubectl scale deployment websocket-api-gateway-deployment --replicas=1
